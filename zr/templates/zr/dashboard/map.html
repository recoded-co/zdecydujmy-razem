{% load i18n %}
<script src="http://openlayers.org/dev/OpenLayers.js"></script>
<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
<style type="text/css">
    .smallmap {
        width: 100%;
        height: 480px;
        border: 1px solid #ccc;
    }
    .olControlPanel div {
      position: absolute;
      left: 12px;
      top: 22px;
      display:block;
      width:  18px;
      height: 18px;
      margin: 5px;
      background-image: url("/static/img/zoom-world-mini.png");
    }
</style>

<script type="text/javascript">
    var lon = 16.9666667;
    var lat = 52.4166667;
    var zoom = 12;
    var map, drawControls, selectedFeature;

    function geolocate(address){
    	var geocoder = new google.maps.Geocoder();
		if (geocoder) {
			geocoder.geocode({ 'address': address+'{{ scope }}', 'region':'pl' }, function (results, status) {
				if (status == google.maps.GeocoderStatus.OK) {
					var geometry = results[0].geometry.location;
					var foundPosition = new OpenLayers.LonLat(geometry.lng(), geometry.lat()).transform(
							new OpenLayers.Projection("EPSG:4326"),
                    		map.getProjectionObject()
                    );
                    var zoom = map.getZoom();
                    zoom = 14;
            		map.setCenter(foundPosition, zoom);

         		} else {
            		console.log("Geocoding failed: " + status);
         		}
      		});
   		}
    }

    function init(){
        map = new OpenLayers.Map('map', {
            projection: 'EPSG:3857',
            layers: [
                new OpenLayers.Layer.OSM('OSM-mapquest',
                    ["http://otile1.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.jpg",
                     "http://otile2.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.jpg",
                     "http://otile3.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.jpg",
                     "http://otile4.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.jpg"]),
                new OpenLayers.Layer.Google(
                    "Google Physical",
                    {type: google.maps.MapTypeId.TERRAIN}
                ),
                new OpenLayers.Layer.Google(
                    "Google Streets", // the default
                    {numZoomLevels: 20}
                ),
                new OpenLayers.Layer.Google(
                    "Google Hybrid",
                    {type: google.maps.MapTypeId.HYBRID, numZoomLevels: 20}
                ),
                new OpenLayers.Layer.Google(
                    "Google Satellite",
                    {type: google.maps.MapTypeId.SATELLITE, numZoomLevels: 22}
                )
            ],
            center: new OpenLayers.LonLat(lon, lat)
                // Google.v3 uses web mercator as projection, so we have to
                // transform our coordinates
                .transform('EPSG:4326', 'EPSG:3857'),
            zoom: zoom,
            controls: [ new OpenLayers.Control.Navigation(),
                        new OpenLayers.Control.Attribution(),
                        new OpenLayers.Control.PanZoomBar()
                        ]

        });

        map.addControl(new OpenLayers.Control.LayerSwitcher());

        var center = new OpenLayers.Control();
        OpenLayers.Util.extend(center, {

            activate: function (bounds) {
                // TODO ustawic do pozycji startowej planu nie do zdefiniowanego czegos
               map.setCenter(new OpenLayers.LonLat(lon, lat)
                .transform('EPSG:4326', 'EPSG:3857'), zoom);
            }
        });
        // center button panel
        var panel = new OpenLayers.Control.Panel({defaultControl: center});
        panel.addControls([center]);
        map.addControl(panel);


        // Draw Points/Polygons on Map
        var layerListeners = {
            featureclick: function(e) {
                console.log(e.object.name + " says: " + e.feature.id + " clicked.");
                return false;
            }
        };

        var pointLayer = new OpenLayers.Layer.Vector("Point Layer",{
            eventListeners: layerListeners
        });

        var polygonLayer = new OpenLayers.Layer.Vector("Polygon Layer",{
            eventListeners: layerListeners
        });
        map.addLayers([pointLayer, polygonLayer]);
        map.addControl(new OpenLayers.Control.MousePosition());
        drawControls = {
            point: new OpenLayers.Control.DrawFeature(pointLayer, OpenLayers.Handler.Point),
            polygon: new OpenLayers.Control.DrawFeature(polygonLayer,OpenLayers.Handler.Polygon)
        };

        // after placing poing/polygon on map draw option switching off
        var controlFeatureHandlerPoint = function(data){
            drawControls.point.deactivate();
        }
        var controlFeatureHandlerPolygon = function(data){
            drawControls.polygon.deactivate();
        }
        drawControls.point.events.register("featureadded", ' ' , controlFeatureHandlerPoint);
        drawControls.polygon.events.register("featureadded", ' ' , controlFeatureHandlerPolygon);


        // functions managing select, unselect popups events
        function onPopupClose(evt) {
            selectControl.unselect(selectedFeature);
        }
        function controlFeatureHandlerPopup (feature){
            selectedFeature = feature;
            popup = new OpenLayers.Popup.FramedCloud("chicken",
                                     feature.geometry.getBounds().getCenterLonLat(),
                                     null,
                                     "<div style='font-size:.8em'>Feature: " + feature.id +"<br>Area: " + feature.geometry.getArea()+"</div>",
                                     null, true, onPopupClose);
            feature.popup = popup;
            map.addPopup(popup);
        }
        function onFeatureUnselect(feature) {
            map.removePopup(feature.popup);
            feature.popup.destroy();
            feature.popup = null;
        }


        var selectPolugonControl = new OpenLayers.Control.SelectFeature(polygonLayer,
        {
            onSelect: controlFeatureHandlerPopup,
            onUnselect: onFeatureUnselect
        });
            map.addControl(selectPolugonControl);
            selectPolugonControl.activate();
        var selectPointControl = new OpenLayers.Control.SelectFeature(pointLayer,
        {
            onSelect: controlFeatureHandlerPopup,
            onUnselect: onFeatureUnselect
        });
            map.addControl(selectPointControl);
            selectPointControl.activate();

        for(var key in drawControls) {
            map.addControl(drawControls[key]);
        }
    }

    function toggleControl(element) {
        window.ele = element;
        var map = {'Dodaj punkt':'point','Dodaj poligon':'polygon'};
        var control = drawControls[map[element.value]];
        control.activate();
    }
    function stripObj(obj){
        window.stripObj = obj;
    }
</script>

<div id="map" class="smallmap"></div>

<ul id="controlToggle">
            <li>
                <input type="button" name="type" value="Dodaj punkt" id="pointToggle" onclick="toggleControl(this);" />
            </li>
            <li>
                <input type="button" name="type" value="Dodaj poligon" id="polygonToggle" onclick="toggleControl(this);" />
            </li>
        </ul>
<!--
<div id="search_form">
	<form name="search_form" action="" method="post">
		<input type="text" id='query' size=50 name="query"/>
		<input type="button" value="{% trans 'Set map' %}" onClick="javascript: geolocate(this.parentNode.childNodes[1].value);return false;"/>
	</form>
</div>-->